# SPDX-License-Identifier: AGPL-3.0-or-later

import os
import glob

from SCons.Environment import Environment


Import('TARGET_ENVIRONMENT')
TARGET_ENVIRONMENT: Environment

# Build the core kernel executable from core/ directory
SConscript('core/SConscript', variant_dir='core_build', duplicate=0)

# Build libmath library explicitly
SConscript('libmath/SConscript', variant_dir='libmath_build', duplicate=0)

# Build optional kernel modules/libraries from other top-level directories
# Each directory under kernel/ (except core/) becomes a separate shared library
import glob
kernel_modules = []

for module_dir in glob.glob('*/'):
    # Skip core/ as it's handled separately above
    if module_dir.startswith('core'):
        continue
    
    # Skip if not a directory with source files
    if not os.path.isdir(module_dir):
        continue
    
    # Check if directory has any source files
    has_sources = (
        len(glob.glob(f'{module_dir}/*.c')) > 0 or
        len(glob.glob(f'{module_dir}/*.cpp')) > 0 or
        len(glob.glob(f'{module_dir}/*.rs')) > 0 or
        len(glob.glob(f'{module_dir}/**/*.c', recursive=True)) > 0 or
        len(glob.glob(f'{module_dir}/**/*.cpp', recursive=True)) > 0 or
        len(glob.glob(f'{module_dir}/**/*.rs', recursive=True)) > 0
    )
    
    if has_sources:
        module_name = module_dir.rstrip('/')
        SConscript(
            f'{module_name}/SConscript',
            variant_dir=f'{module_name}_build',
            duplicate=0
        )

# Import core executable
Import('core')

# Import libmath library
Import('libmath_module')

# Collect all kernel components into an array
kernel = [core, libmath_module]

# Import any module libraries that were built
for module_dir in glob.glob('*/'):
    if module_dir.startswith('core'):
        continue
    if not os.path.isdir(module_dir):
        continue
    
    has_sources = (
        len(glob.glob(f'{module_dir}/*.c')) > 0 or
        len(glob.glob(f'{module_dir}/*.cpp')) > 0 or
        len(glob.glob(f'{module_dir}/*.rs')) > 0 or
        len(glob.glob(f'{module_dir}/**/*.c', recursive=True)) > 0 or
        len(glob.glob(f'{module_dir}/**/*.cpp', recursive=True)) > 0 or
        len(glob.glob(f'{module_dir}/**/*.rs', recursive=True)) > 0
    )
    
    if has_sources:
        module_name = module_dir.rstrip('/')
        try:
            Import(f'{module_name}_module')
            kernel.append(locals()[f'{module_name}_module'])
        except:
            pass

Export('kernel')
