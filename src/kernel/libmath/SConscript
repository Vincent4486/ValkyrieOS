# SPDX-License-Identifier: AGPL-3.0-or-later

import os
import subprocess

from SCons.Environment import Environment
from SCons.Script import Dir
from scripts.scons.utility import GlobRecursive

Import('TARGET_ENVIRONMENT')
TARGET_ENVIRONMENT: Environment

env = TARGET_ENVIRONMENT.Clone()

# Get source directory
src_dir = Dir('#src/kernel/libmath').abspath

env.Append(
    # Absolute code with explicit relocations that we'll patch at load time
    CCFLAGS=['-fno-PIC', '-fno-asynchronous-unwind-tables'],
    CFLAGS=['-fno-PIC'],
    CXXFLAGS=['-fno-PIC'],
    LINKFLAGS=[
        '-shared',
        '-Wl,-T', os.path.join(src_dir, 'linker.ld'),
        '-Wl,-Map=' + env.File('libmath.map').path,
        '-Wl,--as-needed',
        '-Wl,-soname,libmath.so',
        '-Wl,-Bsymbolic-functions',  # Resolve internal references locally
    ],
    CPATH=[src_dir],
    CPPPATH=[src_dir],
    # Include source directory for assembly files (nasm -I flag for include paths)
    ASFLAGS=['-I', src_dir + '/', '-f', 'elf']
)

# Glob files directly from the source directory using os.walk
sources = []
for root, dirs, files in os.walk(src_dir):
    for file in files:
        full_path = os.path.join(root, file)
        if file.endswith(('.c', '.cpp', '.asm')):
            # Make path relative to src_dir so SCons puts objects in build dir
            rel_path = os.path.relpath(full_path, src_dir)
            sources.append(rel_path)

# Compile Rust files if rustSupport is enabled
rust_sources = GlobRecursive(env, '*.rs')
rust_objects = []
if TARGET_ENVIRONMENT.get('rustSupport', True) and rust_sources:
    def build_rust(target, source, env):
        src = str(source[0])
        out = str(target[0])
        
        # Remove .rlib extension and replace with .o
        out_obj = out.replace('.rlib', '.o')
        
        # Determine optimization level
        opt_level = '0' if TARGET_ENVIRONMENT['config'] == 'debug' else '3'
        
        # Build rustc command directly (no rustup wrapper)
        cmd = [
            '/home/vincent/.cargo/bin/rustc',
            '--target', 'i686-unknown-linux-gnu',
            '-C', 'no-redzone=on',
            '-C', 'relocation-model=pic',
            '-C', 'code-model=small',
            '-C', f'opt-level={opt_level}',
            '--edition', '2021',
            '--crate-type', 'lib',
            '-o', out_obj,
            src
        ]
        
        # Create environment for rustc with required variables
        rust_env = os.environ.copy()
        rust_env['HOME'] = '/home/vincent'
        rust_env['USER'] = 'vincent'
        result = subprocess.run(cmd, cwd=str(env.Dir('.').srcnode()), env=rust_env)
        if result.returncode != 0:
            return result.returncode
        
        # Rename output to expected name
        if os.path.exists(out_obj):
            os.rename(out_obj, out)
        return 0
    
    rust_builder = env.Builder(
        action=build_rust,
        suffix='.o',
        src_suffix='.rs',
        single_source=True
    )
    env.Append(BUILDERS={'RustObject': rust_builder})
    
    for src in rust_sources:
        obj = env.RustObject(src)
        rust_objects.append(obj)

# Compile objects as shared objects (PIC)
objects = env.SharedObject(sources) + rust_objects

# Build shared library
libmath_so = env.SharedLibrary('libmath', objects)

# Export as libmath_module for kernel build system detection
libmath_module = libmath_so
Export('libmath_module')
