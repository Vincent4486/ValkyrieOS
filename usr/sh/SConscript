# SPDX-License-Identifier: AGPL-3.0-or-later

import os
import subprocess

from SCons.Environment import Environment
from SCons.Script import Dir
from scripts.scons.utility import GlobRecursive

Import('usermode_env')
Import('musl_include')
Import('musl_lib')

env = usermode_env.Clone()

# Get source directory
src_dir = Dir('#usr/sh').abspath

env.Append(
    # Position-independent code for dynamic linking
    CCFLAGS=['-fPIC'],
    CFLAGS=['-fPIC'],
    CXXFLAGS=['-fPIC'],
    LINKFLAGS=[
        '-Wl,-T', os.path.join(src_dir, 'linker.ld'),
        '-Wl,-Map=' + env.File('sh.map').path,
        '-Wl,--as-needed',
        '-pie',  # Position-independent executable
    ],
    CPATH=[src_dir],
    CPPPATH=[src_dir],
    ASFLAGS=['-I', src_dir + '/'],
    # Explicit musl libc linking (order matters: libc then libgcc)
    LIBS=['c', 'gcc'],  # Link libc and libgcc
)

# Glob files directly from the source directory using os.walk
sources = []
for root, dirs, files in os.walk(src_dir):
    for file in files:
        full_path = os.path.join(root, file)
        if file.endswith(('.c', '.cpp', '.S')):
            # Make path relative to src_dir so SCons puts objects in build dir
            rel_path = os.path.relpath(full_path, src_dir)
            sources.append(rel_path)

objects = env.Object(sources)

# Build executable
sh_executable = env.Program('sh', objects)

# Export as sh_module for image build system detection
sh_module = sh_executable
Export('sh_module')
