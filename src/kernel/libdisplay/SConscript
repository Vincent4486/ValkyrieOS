# SPDX-License-Identifier: AGPL-3.0-or-later

import os
import subprocess

from SCons.Environment import Environment
from SCons.Script import Dir
from scripts.scons.utility import GlobRecursive

Import('TARGET_ENVIRONMENT')
TARGET_ENVIRONMENT: Environment

env = TARGET_ENVIRONMENT.Clone()

# Get source directory
src_dir = Dir('#src/kernel/libdisplay').abspath

env.Append(
    # Build static library for display helpers (no PIC needed)
    CCFLAGS=['-fno-PIC', '-fno-asynchronous-unwind-tables'],
    CFLAGS=['-fno-PIC'],
    CXXFLAGS=['-fno-PIC'],
    CPATH=[src_dir, '#include'],
    CPPPATH=[src_dir, '#include'],
    ASFLAGS=['-I', src_dir + '/', '-f', 'elf']
)

# Collect sources from the libdisplay directory
sources = []
for root, dirs, files in os.walk(src_dir):
    for file in files:
        full_path = os.path.join(root, file)
        if file.endswith(('.c', '.cpp', '.asm')):
            rel_path = os.path.relpath(full_path, src_dir)
            sources.append(rel_path)

# Build static objects and archive them into libdisplay.a
objects = env.Object(sources)
libdisplay = env.StaticLibrary('libdisplay', objects)

# Export the library node so other SConscript files can import it
libdisplay_module = libdisplay
Export('libdisplay_module')
